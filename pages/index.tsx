import type { NextPage } from 'next'
import Head from 'next/head'
import NASAImage from '../components/image'
import styles from '../styles/Home.module.css'
import React, {useEffect, useState, useRef} from "react"
import getNasaImages from './api/api'
import ImageLoadingRow from '../components/loading/imageLoadingRow'


const Home: NextPage = () => {
  const IMG_PER_RENDER = 48
  // state variables
  const [imageList, setImageList] = useState([] as any[])
  const imageRef = useRef([] as any[])
  const endOfList = useRef(IMG_PER_RENDER)
  const [scrollYOffset, setYScroll] = useState(0)

  useEffect(() => {
    // get images from API (populate imageRef)
    async function getData() {
      let curiosity: any = await getNasaImages("curiosity")
      let spirit: any = await getNasaImages("spirit")
      let opportunity: any = await getNasaImages("opportunity")
      if(curiosity != undefined && spirit != undefined && opportunity != undefined) {
        imageRef.current = [...spirit.photos, ...opportunity.photos, ...curiosity.photos]
        renderMoreImages(endOfList.current, imageRef.current)
      }
    }
    // call getData only on initial render
    if(imageRef.current.length == 0) {
      getData()
    }
  }, [])


  useEffect(() => {
    function updateCurrentWidth() {
      // update width everytime user scrolls
      setYScroll(window.scrollY)  
    }

    if(document.documentElement.offsetHeight - 5 < scrollYOffset + window.innerHeight && imageRef.current.length != 0) {
      // call this when the user reaches the bottom of the screen
      if(endOfList.current < imageRef.current.length) {
        endOfList.current += IMG_PER_RENDER
        renderMoreImages(endOfList.current, imageRef.current)
      }
    }

    updateCurrentWidth()
    if (typeof window !== 'undefined') {
      [window.addEventListener('scroll', updateCurrentWidth)]
    }
  })

  // render images (update a portion of imageRef to imageList state)
  function renderMoreImages(endOfList: number, images: any) {
    // make sure not to index the list more than there are entries in the list
    let portion = JSON.parse(JSON.stringify(images)).slice(endOfList-IMG_PER_RENDER, endOfList)
    let updatedImageList = [...imageList, ...portion]
    setImageList(updatedImageList)
  }
  
  // error with api
  if (imageList == undefined) return <div></div>

  // still loading in data
  if (imageList.length == 0) {
    return (
      <main className={styles.mainLoading}>
        <ImageLoadingRow />
      </main>
    )
  }

  // data loaded
  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <div className={styles.imageContainer}>
          {imageList.map((imageObj: any, index: number) => {
            return (
              <NASAImage key={index} date={imageObj.earth_date} imageLink={imageObj.img_src} name={imageObj.rover.name} camera={imageObj.camera.name}/>
            )
          })}
        </div>
      </main>

      <footer className={`${styles.imgsLoadedModal} ${styles.fadeIn}`}>
          <p className={styles.imgLoaded}>{endOfList.current > imageRef.current.length ? imageRef.current.length : endOfList.current} / {imageRef.current.length}</p>
        </footer>
    </div>
  )
}

export default Home
